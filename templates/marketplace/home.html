{% extends 'base.html' %}

{% block title %}Home - Smart Agricultural Marketplace{% endblock %}

{% block extra_css %}
<style>
    /* =============================================
       MAIN LAYOUT ADJUSTMENTS
    ============================================= */
    /* Main content specific to Home */
    .main-content {
        padding: 2rem;
    }

    @media (max-width: 991px) {
        .main-content {
            padding: 1rem;
        }
    }

    /* =============================================
       WELCOME BANNER
    ============================================= */
    .welcome-banner {
        background: linear-gradient(135deg, var(--primary-black), #1a1a1a);
        border: 2px solid var(--bright-green);
        border-radius: 20px;
        padding: 2rem 2.5rem;
        margin-bottom: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1.5rem;
        flex-wrap: wrap;
        position: relative;
        overflow: hidden;
        box-shadow: 0 8px 24px rgba(0, 208, 132, 0.2);
    }

    .welcome-banner::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 400px;
        height: 400px;
        background: radial-gradient(circle, rgba(0, 208, 132, 0.15), transparent 70%);
        pointer-events: none;
    }

    .welcome-banner h2 {
        font-size: 1.6rem;
        margin: 0 0 0.25rem;
        color: #fff !important;
    }

    .welcome-banner p {
        color: rgba(255,255,255,0.7) !important;
        margin: 0;
        font-size: 0.9rem;
    }

    .welcome-meta {
        display: flex;
        gap: 1rem;
        margin-top: 0.5rem;
        flex-wrap: wrap;
    }

    .welcome-meta span {
        background: rgba(0, 208, 132, 0.15);
        border: 1px solid var(--bright-green);
        color: var(--bright-green) !important;
        padding: 0.3rem 0.9rem;
        border-radius: 25px;
        font-size: 0.85rem;
        font-weight: 600;
        text-shadow: none !important;
    }

    .welcome-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .welcome-actions .btn {
        font-size: 0.82rem;
        padding: 0.5rem 1rem;
        text-transform: none;
        letter-spacing: 0;
    }

    /* =============================================
       STATS BAR
    ============================================= */
    .stats-bar {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: var(--primary-white);
        border: 2px solid var(--gray-200);
        border-radius: 16px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        border-color: var(--bright-green);
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl);
    }

    .stat-card .stat-number {
        font-family: 'Archivo', sans-serif;
        font-size: 2.5rem;
        font-weight: 900;
        color: var(--bright-green) !important;
        line-height: 1;
        text-shadow: none !important;
    }

    .stat-card .stat-label {
        font-size: 0.85rem;
        color: var(--text-secondary) !important;
        margin-top: 0.5rem;
        text-shadow: none !important;
        font-weight: 600;
    }

    .stat-card i {
        font-size: 1.8rem;
        color: var(--bright-green);
        margin-bottom: 0.75rem;
        display: block;
    }

    @media (max-width: 768px) {
        .stats-bar { grid-template-columns: repeat(2, 1fr); }
    }

    /* =============================================
       MARKET PRICES TICKER
    ============================================= */
    .prices-section {
        background: var(--primary-white);
        border: 2px solid var(--gray-200);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2.5rem;
        overflow: hidden;
        box-shadow: var(--shadow-md);
    }

    .section-title {
        font-family: 'Archivo', sans-serif;
        font-size: 1.25rem;
        font-weight: 800;
        color: var(--text-primary) !important;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .section-title i { color: var(--bright-green); font-size: 1.3rem; }

    .section-title .badge-live {
        background: rgba(220,53,69,0.2);
        border: 1px solid rgba(220,53,69,0.4);
        color: #ff6b7a !important;
        font-size: 0.65rem;
        padding: 0.15rem 0.5rem;
        border-radius: 20px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        animation: pulse 2s infinite;
        text-shadow: none !important;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .price-ticker {
        display: flex;
        gap: 1rem;
        overflow-x: auto;
        padding-bottom: 0.5rem;
        scrollbar-width: none;
    }

    .price-ticker::-webkit-scrollbar { display: none; }

    .price-item {
        background: var(--gray-50);
        border: 2px solid var(--gray-200);
        border-radius: 12px;
        padding: 1rem 1.5rem;
        min-width: 150px;
        text-align: center;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }

    .price-item:hover {
        border-color: var(--bright-green);
        background: var(--primary-white);
        transform: translateY(-2px);
    }

    .price-item .crop-name {
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--text-secondary) !important;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        text-shadow: none !important;
    }

    .price-item .crop-price {
        font-family: 'Archivo', sans-serif;
        font-size: 1.25rem;
        font-weight: 800;
        color: var(--bright-green) !important;
        margin: 0.5rem 0;
        text-shadow: none !important;
    }

    .price-item .crop-unit {
        font-size: 0.75rem;
        color: var(--text-secondary) !important;
        text-shadow: none !important;
    }

    .price-change.up { color: #4caf50 !important; }
    .price-change.down { color: #f44336 !important; }
    .price-change { font-size: 0.75rem; font-weight: 600; text-shadow: none !important; }

    /* =============================================
       TWO COLUMN LAYOUT (Products + Sidebar content)
    ============================================= */
    .content-grid {
        display: grid;
        grid-template-columns: 1fr 340px;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    @media (max-width: 1200px) {
        .content-grid { grid-template-columns: 1fr; }
    }

    /* =============================================
       FEATURED PRODUCTS
    ============================================= */
    .section-card {
        background: var(--primary-white);
        border: 2px solid var(--gray-200);
        border-radius: 20px;
        padding: 2rem;
        box-shadow: var(--shadow-md);
    }

    .product-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    @media (max-width: 576px) {
        .product-grid { grid-template-columns: 1fr; }
    }

    .product-card {
        background: var(--primary-white);
        border: 2px solid var(--gray-200);
        border-radius: 16px;
        overflow: hidden;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    .product-card:hover {
        border-color: var(--bright-green);
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl);
    }

    .product-card-img {
        height: 200px;
        overflow: hidden;
        flex-shrink: 0;
    }

    .product-card-img img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.4s ease;
    }

    .product-card:hover .product-card-img img {
        transform: scale(1.05);
    }

    .product-card-img .no-image {
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #2D5016, #4A7C2A);
        display: flex;
        align-items: center;
        justify-content: center;
        color: rgba(255,255,255,0.3);
        font-size: 2.5rem;
    }

    .product-card-body {
        padding: 1rem;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .product-card-body h6 {
        color: var(--text-primary) !important;
        font-weight: 700;
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
    }

    .product-card-body .location {
        font-size: 0.8rem;
        color: rgba(255,255,255,0.55) !important;
        margin-bottom: 0.75rem;
        text-shadow: none !important;
    }

    .product-card-body .price {
        color: var(--bright-green) !important;
        font-weight: 800;
        font-family: 'Archivo', sans-serif;
        font-size: 1.15rem;
        text-shadow: none !important;
    }

    .product-card-body .farmer {
        font-size: 0.78rem;
        color: rgba(255,255,255,0.45) !important;
        margin-top: 0.4rem;
        text-shadow: none !important;
    }

    /* =============================================
       RIGHT SIDEBAR CONTENT
    ============================================= */
    .right-panel {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    /* Weather Widget - Distinct Color */
    .weather-card {
        background: linear-gradient(135deg, #E0F2FE 0%, #BAE6FD 100%); /* Light Blue Gradient */
        border: 2px solid #7DD3FC;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: var(--shadow-md);
        position: relative;
        overflow: hidden;
    }
    
    .weather-card::after {
        content: '‚õÖ';
        position: absolute;
        top: -20px;
        right: -20px;
        font-size: 8rem;
        opacity: 0.1;
        transform: rotate(20deg);
        pointer-events: none;
    }

    .weather-district .district-name {
        color: #0369A1 !important; /* Dark Blue */
    }
    
    .weather-district .temp {
        color: #0284C7 !important;
        text-shadow: 2px 2px 0px rgba(255,255,255,0.5);
    }
    
    .weather-stat .label { color: #075985 !important; }
    .weather-stat .value { color: #0284C7 !important; }
    
    .district-tab {
        border-color: #7DD3FC;
        color: #0369A1 !important;
        background: rgba(255,255,255,0.4);
    }
    
    .district-tab.active {
        background: #0284C7;
        color: #fff !important;
        border-color: #0284C7;
    }

    .weather-district {
        text-align: center;
        padding: 1rem 0;
    }

    .weather-district .district-name {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-primary) !important;
        margin-bottom: 0.5rem;
    }

    .weather-district .temp {
        font-family: 'Archivo', sans-serif;
        font-size: 3rem;
        font-weight: 900;
        color: var(--bright-orange) !important;
        line-height: 1;
        text-shadow: none !important;
    }

    .weather-district .condition {
        font-size: 0.85rem;
        color: var(--text-secondary) !important;
        margin-top: 0.25rem;
        text-shadow: none !important;
    }

    .weather-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(255,255,255,0.08);
    }

    .weather-stat {
        text-align: center;
    }

    .weather-stat .label {
        font-size: 0.7rem;
        color: var(--text-secondary) !important;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        text-shadow: none !important;
    }

    .weather-stat .value {
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--bright-blue) !important;
        text-shadow: none !important;
    }

    .district-tabs {
        display: flex;
        gap: 0.4rem;
        margin-bottom: 0.75rem;
        overflow-x: auto;
        padding-bottom: 0.4rem;
        scrollbar-width: none; /* Firefox */
    }
    .district-tabs::-webkit-scrollbar { display: none; } /* Safari/Chrome */

    .district-tab {
        padding: 0.3rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        border: 1px solid var(--gray-300);
        color: var(--text-secondary) !important;
        background: transparent;
        transition: all 0.2s ease;
        text-shadow: none !important;
    }

    .district-tab.active,
    .district-tab:hover {
        background: rgba(14, 165, 233, 0.1);
        border-color: var(--bright-blue);
        color: var(--bright-blue) !important;
    }

    /* Recent Orders - Updated Colors */
    .orders-card {
        background: var(--primary-white);
        border: 2px solid var(--gray-200);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: var(--shadow-md);
    }

    .order-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.6rem 0;
        border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .order-item:last-child { border-bottom: none; }

    .order-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: rgba(0, 208, 132, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--bright-green);
        font-size: 1rem;
        flex-shrink: 0;
    }

    .order-info .order-name {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary) !important;
        text-shadow: none !important;
    }

    .order-info .order-date {
        font-size: 0.75rem;
        color: var(--text-secondary) !important;
        text-shadow: none !important;
    }

    .order-amount {
        margin-left: auto;
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--bright-green) !important;
        text-shadow: none !important;
    }

    /* =============================================
       NEWS PREVIEW
    ============================================= */
    .news-preview-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
    }

    @media (max-width: 900px) {
        .news-preview-grid { grid-template-columns: 1fr; }
    }

    .news-preview-card {
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 14px;
        overflow: hidden;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    .news-preview-card:hover {
        border-color: rgba(124,179,66,0.35);
        transform: translateY(-4px);
    }

    .news-preview-card .news-img {
        height: 140px;
        overflow: hidden;
    }

    .news-preview-card .news-img img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .news-preview-card .news-img-placeholder {
        height: 140px;
        background: linear-gradient(135deg, #2D5016, #1A1612);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: rgba(255,255,255,0.2);
    }

    .news-preview-body {
        padding: 1rem;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .news-preview-body .news-cat {
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #7CB342 !important;
        margin-bottom: 0.4rem;
        text-shadow: none !important;
    }

    .news-preview-body h6 {
        color: #fff !important;
        font-size: 0.9rem;
        font-weight: 700;
        line-height: 1.4;
        margin-bottom: 0.5rem;
    }

    .news-preview-body .news-excerpt {
        font-size: 0.8rem;
        color: rgba(255,255,255,0.6) !important;
        line-height: 1.5;
        flex: 1;
        text-shadow: none !important;
    }

    .news-preview-body .news-meta {
        font-size: 0.75rem;
        color: rgba(255,255,255,0.4) !important;
        margin-top: 0.75rem;
        text-shadow: none !important;
    }

    /* =============================================
       TESTIMONIALS
    ============================================= */
    .testimonials-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
    }

    @media (max-width: 900px) {
        .testimonials-grid { grid-template-columns: 1fr; }
    }

    .testimonial-card {
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 14px;
        padding: 1.5rem;
        position: relative;
        transition: all 0.3s ease;
    }

    .testimonial-card:hover {
        border-color: rgba(212,165,116,0.3);
        transform: translateY(-3px);
    }

    .testimonial-card .quote-icon {
        font-size: 2.5rem;
        color: rgba(124,179,66,0.25);
        line-height: 1;
        font-family: Georgia, serif;
        margin-bottom: 0.5rem;
    }

    .testimonial-card .quote-text {
        font-size: 0.875rem;
        color: rgba(255,255,255,0.8) !important;
        line-height: 1.6;
        font-style: italic;
        margin-bottom: 1rem;
        text-shadow: none !important;
    }

    .testimonial-author {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .author-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #4A7C2A, #7CB342);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        color: white;
        font-weight: 700;
        flex-shrink: 0;
    }

    .author-name {
        font-size: 0.85rem;
        font-weight: 700;
        color: #fff !important;
        text-shadow: none !important;
    }

    .author-role {
        font-size: 0.75rem;
        color: rgba(255,255,255,0.45) !important;
        text-shadow: none !important;
    }

    .star-rating { color: #FDB927; font-size: 0.8rem; }

    /* =============================================
       CATEGORIES
    ============================================= */
    .categories-grid {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-bottom: 2rem;
    }

    .category-chip {
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 50px;
        padding: 0.5rem 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: rgba(255,255,255,0.75) !important;
        text-decoration: none;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.2s ease;
        text-shadow: none !important;
    }

    .category-chip:hover {
        background: rgba(124,179,66,0.15);
        border-color: rgba(124,179,66,0.4);
        color: #7CB342 !important;
        transform: translateY(-2px);
    }

    /* =============================================
       PLATFORM FEATURES
    ============================================= */
    .features-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
    }

    @media (max-width: 900px) {
        .features-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 576px) {
        .features-grid { grid-template-columns: 1fr; }
    }

    .feature-card {
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 14px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .feature-card:hover {
        transform: translateY(-5px);
        border-color: rgba(124,179,66,0.3);
        box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }

    .feature-icon-wrap {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
        font-size: 1.6rem;
    }

    .feature-card h6 {
        color: #fff !important;
        font-weight: 700;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .feature-card p {
        color: rgba(255,255,255,0.65) !important;
        font-size: 0.82rem;
        line-height: 1.5;
        margin-bottom: 1rem;
        text-shadow: none !important;
    }

    /* =============================================
       HERO SECTION
    ============================================= */
    .hero-section {
        background: linear-gradient(135deg, var(--primary-black), #1a1a1a);
        border: 3px solid var(--bright-green);
        border-radius: 24px;
        padding: 4rem 2.5rem;
        margin-bottom: 2.5rem;
        text-align: center;
        position: relative;
        overflow: hidden;
        box-shadow: 0 12px 32px rgba(0, 208, 132, 0.2);
    }

    .hero-section::before {
        content: '';
        position: absolute;
        top: -30%;
        left: 50%;
        transform: translateX(-50%);
        width: 700px;
        height: 400px;
        background: radial-gradient(ellipse, rgba(0, 208, 132, 0.15), transparent 70%);
        pointer-events: none;
    }

    .hero-section h1 {
        font-size: clamp(1.8rem, 4vw, 3rem) !important;
        color: #fff !important;
        margin-bottom: 0.75rem;
    }

    .hero-section .lead {
        color: rgba(255,255,255,0.8) !important;
        font-size: 1.1rem;
        margin-bottom: 1.5rem;
    }

    .hero-badges {
        display: flex;
        justify-content: center;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
    }

    .hero-badge {
        background: rgba(253,185,39,0.12);
        border: 1px solid rgba(253,185,39,0.3);
        color: #FDB927 !important;
        padding: 0.3rem 0.9rem;
        border-radius: 20px;
        font-size: 0.82rem;
        font-weight: 600;
        text-shadow: none !important;
    }

    /* Recommended section */
    .recommended-section {
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}

    <!-- PERSONALIZED WELCOME BANNER (logged in only) -->
        {% if user.is_authenticated %}
        <div class="welcome-banner">
            <div>
                <h2>üëã Welcome back, {{ user.username|title }}!</h2>
                <p>Here's what's happening on AgriMarket today.</p>
                <div class="welcome-meta">
                    {% if user.district %}
                    <span><i class="bi bi-geo-alt"></i> {{ user.district }}</span>
                    {% endif %}
                    {% if user.specialization %}
                    <span><i class="bi bi-award"></i> {{ user.specialization }}</span>
                    {% endif %}
                    <span><i class="bi bi-person-badge"></i> {{ user.user_type|title }}</span>
                </div>
            </div>
            <div class="welcome-actions">
                <a href="{% url 'marketplace:product_list' %}" class="btn btn-success">
                    <i class="bi bi-bag"></i> Buy Now
                </a>
            </div>
        </div>
        {% else %}
        <!-- HERO for guests -->
        <div class="hero-section">
            <h1><i class="bi bi-basket"></i> Welcome to AgriMarket</h1>
            <p class="lead">Connecting Ugandan farmers directly with consumers and businesses</p>
            <div class="hero-badges">
                <span class="hero-badge"><i class="bi bi-check-circle-fill"></i> Fresh Products</span>
                <span class="hero-badge"><i class="bi bi-check-circle-fill"></i> Fair Prices</span>
                <span class="hero-badge"><i class="bi bi-check-circle-fill"></i> Direct from Farmers</span>
            </div>
            <div class="d-flex gap-2 justify-content-center flex-wrap">
                <a href="{% url 'marketplace:product_list' %}" class="btn btn-success btn-lg">
                    <i class="bi bi-search"></i> Browse Products
                </a>
                <a href="{% url 'accounts:register' %}" class="btn btn-outline-success btn-lg">
                    <i class="bi bi-person-plus"></i> Join Free
                </a>
            </div>
        </div>
        {% endif %}

        <!-- STATS BAR -->
        <div class="stats-bar">
            <div class="stat-card">
                <i class="bi bi-basket3"></i>
                <div class="stat-number">{{ total_products|default:"0" }}</div>
                <div class="stat-label">Products Listed</div>
            </div>
            <a href="{% url 'marketplace:farmer_list' %}" class="stat-card text-decoration-none" style="color: inherit; transition: transform 0.2s;">
                <i class="bi bi-people"></i>
                <div class="stat-number">{{ total_farmers|default:"0" }}</div>
                <div class="stat-label">Active Farmers</div>
            </a>
            <div class="stat-card p-0 border-0 overflow-hidden position-relative" style="background: linear-gradient(135deg, #064e3b, #042f2e); padding: 0;">
                <div class="p-3 text-center d-flex flex-column justify-content-center h-100 position-relative">
                   <div class="position-absolute top-0 start-0 w-100 h-100" style="opacity: 0.1; background-image: url('https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png'); background-repeat: repeat;"></div>
                    <div style="font-size: 1.5rem; color: #00D084; margin-bottom: 0.2rem;"><i class="bi bi-map-fill"></i></div>
                    <h6 class="fw-bold text-white mb-1" style="font-size: 0.9rem;">Explore Districts</h6>
                    <a href="{% url 'marketplace:district_list' %}" class="btn btn-success rounded-pill fw-bold position-relative z-1 mt-2" style="font-size: 0.65rem; padding: 0.25rem 0.8rem;">
                        <i class="bi bi-geo-alt me-1"></i> Open Map
                    </a>
                </div>
            </div>
            <div class="stat-card">
                <i class="bi bi-bag-check"></i>
                <div class="stat-number">500+</div>
                <div class="stat-label">Orders Completed</div>
            </div>
        </div>

        <!-- LIVE MARKET PRICES -->
        <div class="prices-section">
            <div class="section-title">
                <i class="bi bi-graph-up-arrow"></i>
                Live Market Prices
                <span class="badge-live">‚óè Live</span>
            </div>
            <div class="price-ticker">
                {% if hybrid_prices %}
                    {% for price in hybrid_prices|slice:":8" %}
                    <div class="price-item">
                        <div class="crop-name">
                            {{ price.product_name }}
                            {% if price.has_wfp %}
                                <span style="font-size:0.6rem;padding:0.15rem 0.4rem;border-radius:10px;background:#0EA5E9;color:white;font-weight:700;">WFP</span>
                            {% endif %}
                            {% if price.has_crowdsourced %}
                                <span style="font-size:0.6rem;padding:0.15rem 0.4rem;border-radius:10px;background:#00D084;color:white;font-weight:700;">üë®‚Äçüåæ</span>
                            {% endif %}
                        </div>
                        <div class="crop-price">
                            {% if price.has_wfp %}
                                {{ price.wfp_price|floatformat:0 }}
                            {% elif price.has_crowdsourced %}
                                {{ price.crowdsourced_price|floatformat:0 }}
                            {% endif %}
                        </div>
                        <div class="crop-unit">UGX/{{ price.unit }}</div>
                    </div>
                    {% endfor %}
                {% else %}
                    <!-- Fallback prices -->
                    <div class="price-item">
                        <div class="crop-name">Maize</div>
                        <div class="crop-price">1,200</div>
                        <div class="crop-unit">UGX/kg</div>
                    </div>
                    <div class="price-item">
                        <div class="crop-name">Beans</div>
                        <div class="crop-price">3,500</div>
                        <div class="crop-unit">UGX/kg</div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- MAIN CONTENT GRID: Products + Right Panel -->
        <div class="content-grid">

            <!-- FEATURED PRODUCTS -->
            <div>
                <div class="section-card">
                    <div class="section-title">
                        <i class="bi bi-star-fill"></i> Featured Products
                        <a href="{% url 'marketplace:product_list' %}" class="ms-auto" style="font-size: 0.8rem; color: #7CB342 !important; text-decoration: none; font-weight: 600;">View all ‚Üí</a>
                    </div>
                    <div class="product-grid">
                        {% for product in featured_products %}
                        <div class="product-card">
                            <div class="product-card-img">
                                {% if product.image %}
                                    <img src="{{ product.image.url }}" alt="{{ product.name }}">
                                {% else %}
                                    <div class="no-image"><i class="bi bi-image"></i></div>
                                {% endif %}
                            </div>
                            <div class="product-card-body">
                                <span class="badge bg-success mb-1" style="font-size: 0.7rem;">{{ product.category.name }}</span>
                                <h6>{{ product.name }}</h6>
                                <p class="location"><i class="bi bi-geo-alt"></i> {{ product.location }}</p>
                                <div class="d-flex justify-content-between align-items-center mt-auto">
                                    <span class="price">UGX {{ product.price|floatformat:0 }}/{{ product.unit }}</span>
                                    <a href="{% url 'marketplace:product_detail' product.pk %}" class="btn btn-primary btn-sm" style="font-size: 0.75rem; padding: 0.3rem 0.75rem;">View</a>
                                </div>
                                <p class="farmer"><i class="bi bi-person"></i> {{ product.farmer.username }}</p>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-span-2 text-center py-4" style="color: rgba(255,255,255,0.5);">
                            No products yet.
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- RIGHT PANEL -->
            <div class="right-panel">

                <!-- WEATHER WIDGET -->
                <div class="weather-card">
                    <div class="section-title">
                        <i class="bi bi-cloud-sun"></i> Weather
                    </div>
                    <div class="district-tabs">
                        <button class="district-tab active" onclick="showWeatherSpecific('Kampala')">Kampala</button>
                        <button class="district-tab" onclick="showWeatherSpecific('Gulu')">Gulu</button>
                        <button class="district-tab" onclick="showWeatherSpecific('Mbarara')">Mbarara</button>
                        <button class="district-tab" onclick="showWeatherSpecific('Mbale')">Mbale</button>
                    </div>
                    <div class="weather-district">
                        <div class="district-name" id="weather-district">Kampala</div>
                        <div class="temp" id="weather-temp">28¬∞C</div>
                        <div class="condition" id="weather-condition"><i class="bi bi-cloud-sun"></i> Partly Cloudy</div>
                    </div>
                    <div class="weather-stats">
                        <div class="weather-stat">
                            <div class="label">Humidity</div>
                            <div class="value" id="weather-humidity">70%</div>
                        </div>
                        <div class="weather-stat">
                            <div class="label">Wind</div>
                            <div class="value" id="weather-wind">12km/h</div>
                        </div>
                        <div class="weather-stat">
                            <div class="label">Farming</div>
                            <div class="value" id="weather-farming" style="color: #7CB342 !important;">Good</div>
                        </div>
                    </div>
                </div>



                <!-- RECENT ORDERS (logged in only) -->
                {% if user.is_authenticated %}
                <div class="orders-card">
                    <div class="section-title">
                        <i class="bi bi-bag-check"></i> Recent Orders
                        <a href="{% url 'orders:my_orders' %}" class="ms-auto" style="font-size: 0.8rem; color: #7CB342 !important; text-decoration: none;">View all ‚Üí</a>
                    </div>
                    {% if recent_orders %}
                        {% for order in recent_orders %}
                        <div class="order-item">
                            <div class="order-icon"><i class="bi bi-bag"></i></div>
                            <div class="order-info">
                                <div class="order-name">Order #{{ order.id }}</div>
                                <div class="order-date">{{ order.created_at|date:"M d, Y" }}</div>
                            </div>
                            <div class="order-amount">UGX {{ order.total_amount|floatformat:0 }}</div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div style="text-align:center; padding: 1rem 0; color: rgba(255,255,255,0.4) !important; font-size: 0.85rem;">
                            <i class="bi bi-bag" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
                            No orders yet
                        </div>
                    {% endif %}
                </div>
                {% endif %}

            </div>
        </div>

        <!-- CATEGORIES -->
        <div class="section-title"><i class="bi bi-grid"></i> Browse by Category</div>
        <div class="categories-grid">
            {% for category in categories %}
            <a href="{% url 'marketplace:product_list' %}?category={{ category.id }}" class="category-chip">
                <i class="bi bi-tag"></i> {{ category.name }}
            </a>
            {% empty %}
            <p style="color: rgba(255,255,255,0.5);">No categories yet.</p>
            {% endfor %}
        </div>

        <!-- AGRI-PULSE NEWS PREVIEW -->
        <div class="section-title" style="margin-bottom: 1rem;">
            <i class="bi bi-newspaper"></i> Latest Agri-Pulse News
            <a href="{% url 'news:news_list' %}" class="ms-auto" style="font-size: 0.8rem; color: #7CB342 !important; text-decoration: none;">Read all ‚Üí</a>
        </div>
        <div class="news-preview-grid">
            {% for article in latest_news %}
            <div class="news-preview-card">
                {% if article.image %}
                <div class="news-img"><img src="{{ article.image.url }}" alt="{{ article.title }}"></div>
                {% else %}
                <div class="news-img-placeholder"><i class="bi bi-newspaper"></i></div>
                {% endif %}
                <div class="news-preview-body">
                    <div class="news-cat">{{ article.category }}</div>
                    <h6>{{ article.title }}</h6>
                    <p class="news-excerpt">{{ article.content|truncatewords:15 }}</p>
                    <div class="news-meta d-flex justify-content-between">
                        <span><i class="bi bi-person"></i> {{ article.author.username }}</span>
                        <span>{{ article.created_at|date:"M d" }}</span>
                    </div>
                </div>
            </div>
            {% empty %}
            <div style="grid-column: span 3; text-align:center; padding: 2rem; color: rgba(255,255,255,0.4);">
                <i class="bi bi-newspaper" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
                No news articles yet. <a href="{% url 'news:news_list' %}" style="color: #7CB342;">Check the news page</a>
            </div>
            {% endfor %}
        </div>

        <!-- PLATFORM FEATURES -->
        <div class="section-title" style="margin-bottom: 1rem;"><i class="bi bi-grid-3x3-gap"></i> Platform Features</div>
        <div class="features-grid">
            <div class="feature-card">
                <div class="feature-icon-wrap" style="background: rgba(74,124,42,0.15);">
                    <i class="bi bi-shop" style="color: #7CB342;"></i>
                </div>
                <h6>Input Store</h6>
                <p>Quality seeds, fertilizers, and tools from verified suppliers</p>
                <a href="{% url 'inputs:input_store' %}" class="btn btn-outline-success btn-sm">Explore</a>
            </div>
            <div class="feature-card">
                <div class="feature-icon-wrap" style="background: rgba(135,206,235,0.15);">
                    <i class="bi bi-newspaper" style="color: #87CEEB;"></i>
                </div>
                <h6>Agri-Pulse News</h6>
                <p>Stay updated with policies and agricultural news</p>
                <a href="{% url 'news:news_list' %}" class="btn btn-outline-info btn-sm">Read News</a>
            </div>
            <div class="feature-card">
                <div class="feature-icon-wrap" style="background: rgba(253,185,39,0.15);">
                    <i class="bi bi-cloud-sun" style="color: #FDB927;"></i>
                </div>
                <h6>Climate Suite</h6>
                <p>Weather forecasts and planting season guidance</p>
                <a href="{% url 'weather:climate_suite' %}" class="btn btn-outline-warning btn-sm">View Dashboard</a>
            </div>
            <div class="feature-card">
                <div class="feature-icon-wrap" style="background: rgba(255,152,0,0.15);">
                    <i class="bi bi-people" style="color: #FF9800;"></i>
                </div>
                <h6>Group Buying</h6>
                <p>Join with other farmers to buy inputs in bulk at lower prices</p>
                <a href="{% url 'inputs:group_buy_list' %}" class="btn btn-outline-warning btn-sm">View Pools</a>
            </div>
            <div class="feature-card">
                <div class="feature-icon-wrap" style="background: rgba(244,67,54,0.15);">
                    <i class="bi bi-graph-up-arrow" style="color: #F44336;"></i>
                </div>
                <h6>Price Tracker</h6>
                <p>Crowdsourced prices from farmers to fight exploitation</p>
                <a href="{% url 'marketplace:price_tracker' %}" class="btn btn-outline-danger btn-sm">View Prices</a>
            </div>
            <div class="feature-card">
                <div class="feature-icon-wrap" style="background: rgba(124,179,66,0.15);">
                    <i class="bi bi-exclamation-triangle" style="color: #7CB342;"></i>
                </div>
                <h6>Distress Sale Alerts</h6>
                <p>Help farmers find urgent buyers for perishable produce</p>
                <a href="{% url 'marketplace:product_list' %}?urgent=1" class="btn btn-outline-success btn-sm">View Urgent</a>
            </div>
        </div>

        <!-- TESTIMONIALS -->
        <div class="section-title" style="margin-bottom: 1rem;"><i class="bi bi-chat-quote"></i> What Farmers Say</div>
        <div class="testimonials-grid">
            <div class="testimonial-card">
                <div class="quote-icon">"</div>
                <p class="quote-text">AgriMarket helped me sell my tomatoes directly to buyers in Kampala. I now earn 40% more than selling through middlemen.</p>
                <div class="testimonial-author">
                    <div class="author-avatar">JM</div>
                    <div>
                        <div class="author-name">James Mukasa</div>
                        <div class="author-role">Farmer, Wakiso District</div>
                        <div class="star-rating">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                    </div>
                </div>
            </div>
            <div class="testimonial-card">
                <div class="quote-icon">"</div>
                <p class="quote-text">The group buying feature saved us 30% on fertilizer costs this season. We organized 15 farmers and got a bulk discount.</p>
                <div class="testimonial-author">
                    <div class="author-avatar">SA</div>
                    <div>
                        <div class="author-name">Sarah Amongi</div>
                        <div class="author-role">Farmer, Gulu District</div>
                        <div class="star-rating">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                    </div>
                </div>
            </div>
            <div class="testimonial-card">
                <div class="quote-icon">"</div>
                <p class="quote-text">The climate dashboard tells me exactly when to plant. My yields have improved significantly since I started using the platform.</p>
                <div class="testimonial-author">
                    <div class="author-avatar">PO</div>
                    <div>
                        <div class="author-name">Peter Okello</div>
                        <div class="author-role">Farmer, Mbale District</div>
                        <div class="star-rating">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</div>
                    </div>
                </div>
            </div>
        </div>

    </div><!-- end main-content -->
</div><!-- end page-wrapper -->

<!-- Mobile sidebar toggle button -->
<button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
    <i class="bi bi-layout-sidebar"></i>
</button>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-dismiss welcome banner
        const banner = document.querySelector('.welcome-banner');
        if (banner) {
            setTimeout(() => {
                // Set explicit height for transition to work
                banner.style.height = banner.scrollHeight + 'px';
                banner.style.transition = 'all 0.8s ease-in-out';
                banner.style.overflow = 'hidden';
                
                // Force reflow
                void banner.offsetHeight;

                // Collapse
                banner.style.opacity = '0';
                banner.style.height = '0';
                banner.style.marginTop = '0';
                banner.style.marginBottom = '0';
                banner.style.padding = '0';
                banner.style.border = 'none';
                
                setTimeout(() => {
                    banner.remove();
                }, 800);
            }, 4000); // Reduced to 4 seconds for faster feedback
        }
    });

// Weather widget helper for tabs
function showWeatherSpecific(districtName) {
    const d = getSimulatedWeather(districtName);
    updateWeatherUI(d);
    
    // Manual click pauses auto-rotation for 30s? (Optional, let's just update)
    // Find matching index in list to continue from there
    const newIdx = allDistrictsData.findIndex(item => item.name === districtName);
    if (newIdx !== -1) weatherIndex = newIdx;
}

function updateWeatherUI(d) {
    // Update active tab if it exists
    const tabs = document.querySelectorAll('.district-tab');
    tabs.forEach(t => {
        t.classList.remove('active');
        if (t.textContent === d.district) t.classList.add('active');
    });
    
    // Update elements
    const distEl = document.getElementById('weather-district');
    const tempEl = document.getElementById('weather-temp');
    const condEl = document.getElementById('weather-condition');
    const humEl = document.getElementById('weather-humidity');
    const windEl = document.getElementById('weather-wind');
    const farmEl = document.getElementById('weather-farming');
    
    if (distEl) distEl.textContent = d.district;
    if (tempEl) tempEl.textContent = d.temp;
    if (condEl) condEl.innerHTML = `<i class="bi ${d.icon}"></i> ${d.condition}`;
    if (humEl) humEl.textContent = d.humidity;
    if (windEl) windEl.textContent = d.wind;
    if (farmEl) {
        farmEl.textContent = d.farming;
        if (d.farming === 'Excellent') farmEl.style.color = '#43A047';
        else if (d.farming === 'Good') farmEl.style.color = '#7CB342';
        else farmEl.style.color = '#FB8C00';
    }
}

// Mobile sidebar toggle
const sidebarToggle = document.getElementById('sidebarToggle');
const sidebar = document.getElementById('sidebar');

sidebarToggle.addEventListener('click', () => {
    sidebar.classList.toggle('open');
});

// Close sidebar when clicking outside on mobile
document.addEventListener('click', (e) => {
    if (window.innerWidth <= 991) {
        if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
            sidebar.classList.remove('open');
        }
    }
});

// Auto-rotate weather districts
let weatherIndex = 0;

// Flatten districts from context
const allDistrictsData = [];
{% for region, districts in all_districts.items %}
    {% for district in districts %}
        allDistrictsData.push({
            name: "{{ district }}",
            region: "{{ region }}"
        });
    {% endfor %}
{% endfor %}

function getSimulatedWeather(districtName) {
    // Generate somewhat realistic weather based on district/random
    const temps = [24, 25, 26, 27, 28, 29, 30, 31, 32];
    const conditions = ['Sunny', 'Partly Cloudy', 'Cloudy', 'Light Rain', 'Clear'];
    const icons = ['bi-sun', 'bi-cloud-sun', 'bi-cloud', 'bi-cloud-drizzle', 'bi-brightness-high'];
    const farming = ['Excellent', 'Good', 'Fair'];
    
    // Use hash of name for consistency if needed, or just random
    const randIdx = Math.floor(Math.random() * conditions.length);
    const tempIdx = Math.floor(Math.random() * temps.length);
    const farmIdx = Math.floor(Math.random() * farming.length);
    
    return {
        district: districtName,
        temp: temps[tempIdx] + '¬∞C',
        condition: conditions[randIdx],
        icon: icons[randIdx],
        humidity: (60 + Math.floor(Math.random() * 30)) + '%',
        wind: (5 + Math.floor(Math.random() * 15)) + 'km/h',
        farming: farming[farmIdx]
    };
}

// Initial state
let currentWeather = getSimulatedWeather(allDistrictsData[0].name);

setInterval(() => {
    weatherIndex = (weatherIndex + 1) % allDistrictsData.length;
    const d = getSimulatedWeather(allDistrictsData[weatherIndex].name);
    updateWeatherUI(d);
}, 8000);

</script>



{% endblock %}