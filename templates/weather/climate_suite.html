{% extends 'base.html' %}

{% block title %}Climate Suite - Uganda Forecast{% endblock %}

{% block content %}
<style>
    .climate-dashboard { max-width: 900px; margin: 40px auto; }
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #28a745;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .district-btn.active { background-color: #198754 !important; color: white !important; }
    #weather-data { min-height: 150px; }
    .weather-val { font-size: 2.5rem; font-weight: bold; color: #198754; }
</style>

<div class="climate-dashboard">
    <div class="text-center mb-5">
        <h2 class="display-5 fw-bold"><i class="bi bi-cloud-sun"></i> Uganda Climate Forecast</h2>
        <p class="text-secondary lead">Real-time weather data for Ugandan districts</p>
    </div>

    <div class="card border-0 shadow-lg mb-4">
        <div class="card-body p-5">
            <div id="current-district-display" class="text-center">
                <h3 id="district-name" class="text-uppercase tracking-wider mb-4 text-muted">Loading...</h3>
                <div id="weather-data">
                    <div class="py-5">
                        <div class="loading-spinner"></div>
                        <p class="mt-3 text-muted">Fetching latest atmospheric data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="text-center">
        <label class="d-block small text-uppercase text-muted mb-2">Featured Regions</label>
        <div class="btn-group flex-wrap justify-content-center" role="group" id="district-indicators">
            {% for district in featured_districts %}
            <button type="button" class="btn btn-outline-success btn-sm district-btn m-1" 
                    data-district="{{ district }}">
                {{ district }}
            </button>
            {% endfor %}
        </div>
    </div>
</div>

<script>
let currentIndex = 0;
const districts = {{ featured_districts|safe }};
let rotationInterval;

function showDistrict(index) {
    currentIndex = index;
    const district = districts[index];
    
    // Update active UI
    document.querySelectorAll('.district-btn').forEach((btn, i) => {
        btn.classList.toggle('active', i === index);
    });
    
    document.getElementById('district-name').textContent = district;
    fetchWeatherData(district);
}

async function fetchWeatherData(district) {
    const dataContainer = document.getElementById('weather-data');
    
    try {
        // NOTE: You need a Django view that returns JSON at this URL
        const response = await fetch(`/weather/api/get-weather/?district=${district}`);
        const data = await response.json();

        if (data.error) throw new Error(data.error);

        dataContainer.innerHTML = `
            <div class="row text-center animate__animated animate__fadeIn">
                <div class="col-md-4 mb-3">
                    <div class="weather-val">${Math.round(data.temperature)}Â°C</div>
                    <p class="text-muted"><i class="bi bi-thermometer-half"></i> Temperature</p>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="weather-val">${data.humidity}%</div>
                    <p class="text-muted"><i class="bi bi-droplet"></i> Humidity</p>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="weather-val">${data.wind_speed} <small>km/h</small></div>
                    <p class="text-muted"><i class="bi bi-wind"></i> Wind Speed</p>
                </div>
            </div>
            <div class="text-center mt-3">
                <span class="badge bg-light text-dark p-2 text-capitalize">${data.description}</span>
            </div>
        `;
    } catch (error) {
        dataContainer.innerHTML = `
            <div class="alert alert-soft-danger">
                <i class="bi bi-exclamation-triangle"></i> Data unavailable for ${district}.
            </div>
        `;
    }
}

function startRotation() {
    clearInterval(rotationInterval);
    rotationInterval = setInterval(() => {
        currentIndex = (currentIndex + 1) % districts.length;
        showDistrict(currentIndex);
    }, 10000);
}

document.querySelectorAll('.district-btn').forEach((btn, index) => {
    btn.addEventListener('click', () => {
        showDistrict(index);
        startRotation(); // Reset timer on manual click
    });
});

// Initialize
if(districts.length > 0) {
    showDistrict(0);
    startRotation();
}
</script>
{% endblock %}